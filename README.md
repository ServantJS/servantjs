# ServantJS
**ServantJS** - это платформа для централизованного управления инфраструктурой. Платформа рассчитана на написание модулей, позволяющих расширить ее функционал до нужного, например ведение общей базы конфигурационных файлов какого-либо приложения, или мониторинг приложений и серверов.

## Особенности

* *Кроссплатформенность*: ServantJS основ на Node.js, поэтому может быть запущен практически на любой операционной системе.
* *Централизованность*: ServantJS позволяет отправлять задания своим агентам как для автоматизации бизнес процессов, так и для обеспечения единой информацией нескольких серверов (например поддержка одинаковых настроек веб-сервера nginx для отказоустойчивости).
* *Модульность*: "Из коробки" доступна только обработка новых подключений и мониторинг базы данных на новые задания. С помощью модулей и middleware можно расширять функционал платформы до нужного.
* *API*: В наличие имеется REST API сервер для интеграции с другими приложениями и сервисами.
* *Панель управления*: Для удобного администрирование пользователю предлагается Web интерфейс для управления платформой и 
всеми ее модулями.

## Почему не Puppet или Chef?

Такие программные продукты как Puppet и Chef предлагают подобный функционал для централизованного развертывания чего-либо. Но, как правильно, она заточены для развертывания серверной\облачной инфраструктуры, а также приложений на серверах. Минусом является то, что они не рассчитаны на хранения конфигурационных файлов, например, как сущностей в виде "клиента". Модули ServantJS могут обладать любым по сложности функционалом, начиная от конфигурирования приложения и заканчивая ~~автоматическим развертывание виртуальных машим в облаке~~ вашим воображением.
 
ServantJS прежде всего рассчитан для программистов, которые могут дописать ServantJS под себя с помощью своих модулей. Puppet и Chef изначально требуют знаний скриптовых языков и своих встроенных для начальной работы. ServantJS для конечных пользователей не требует навыков программирование. Панель управления дает уже необходимый набор инструментов для работы.

## Как это работает

Основа ServantJS сервера состоит в приеме новых подключений от агентов и мониторинге базы данных на новые задания. Задания представляют собой набор параметров и команду для выполнение. Каждое задание отправляется на обработку в свой модуль.

Модули обрабатывают поступающие задания и отправляют их агентам (если необходимо), которые, в свое время, должны выполнить необходимый набор инструкций, указанный в принятом пакете. После завершения выполнения инструкций агент отправляет отчет на сервер.
 
Администратор может просматривать подробно каждое задание и отчет об его выполнение в панели управления.

## Что уже есть

В качестве демонстрации написан первый модуль для централизованного управления серверами с установленным HAProxy. Как минимум, неудобство в конфигурирование HAProxy заключается в том, что нет возможности собирать конфигурационный файл из нескольких файлов. Модуль позволяет это сделать. То есть пользователь видит настройки в виде блоков,  которые он упорядочивает в нужной последовательности, в то время как на конечном сервер это один файл. Блоки можно убирать из файла, при этом оставляя его в базе данных, или же можно его полностью удалить.

## Создание модуля

### Структура модуля

Ниже представлена базовая структура каждого модуля. У модуля есть собственый набор middleware обработчиков и наличие класса, унаследованного от BaseModule, который должен реализовать метод handle и инициализировать обработчики своих событий. В папке models содержатся схемы, необходимые для модуля. В файле db.js происходит экспорт всех моделей на основе схем.
 
index.js файл должен вернуть массив middleware обработчиков и объект класса модуля.
 
```
module_name/
├── middlewares/
│   ├── middleware_handle.js
│   ├── ...
│   ├── index.js
├── models/
│    ├── schemas/
│    │   └── schema.js     
│    └── index.js
├── db.js
├── index.js
└── module.js

```


Для примера, в папке modules, расположен template модуль. Он наглядно демонстрирует в каком виде должен быть организована модуль, а также как и что должно инициализироваться.

### Реализация middleware

middleware обработчики могут выполняться на разных стадиях обработки сообщений между сервером и агентом. Ниже представлен существующий список стадий:

* MESSAGE_RECEIVED_STAGE - получено сообщение от агента. Сообщение в виде объекта класса ServantMessage. 
* MODULE_STAGE - срабатывает сразу после стадии MESSAGE_RECEIVED_STAGE. На этой стадии сообщение отправляется модулю в метод handle.
* MESSAGE_SEND_STAGE - срабатывает сразу после того, как модуль вызовет метод sendMessage для отправки пакета заданий агенту 
* TASK_RECEIVED_STAGE - срабатывает, когда модуль получает новое задание из БД

## Требования для установки

* **MongoDB** >= 3.0
* **Node.js** >= 5.0.0
* **NPM** >= 2.0.0

## Цели

В идеальном далеком будущем ServantJS будет содержать большое кол-во модулей для управления различными приложения, а также наличие мониторинга приложений и серверов. 

## Контакты

Если у вас есть вопрос или предложения, то пишите на почту servantjs.company@gmail.com или оставляйте свои пожелания через "Issue" в github'е.

